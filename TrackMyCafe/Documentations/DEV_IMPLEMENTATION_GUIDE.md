# TrackMyCafe — Dev Implementation Guide (MVP)

## Мета
- Єдиний фокус: прибуток у реальному часі = продажі − COGS − операційні витрати.
- Killer-фіча: радикальна простота — мінімум полів, автоматика розрахунків, швидкі дії.

## Архітектура (огляд)
- Зберігання: локально (Realm). UUID для `id`, дати — ISO8601.
- Собівартість: середньозважена (FIFO додамо пізніше).
- Вплив: кожна операція миттєво оновлює запаси, COGS та дашборд.
- Постачальники: на старті не вводимо; `supplierId` закладений у `Purchase` як необов’язковий, фільтри готові.

---

## 1. Онбордінг / Налаштування (MVP)
**Призначення**: мінімум для старту роботи.
- UI:
  - Товар: назва, `salePrice`, одиниця (`unit`).
  - Рецепт: список інгредієнтів із кількістю на 1 порцію (`qtyPerUnit`).
  - Категорії Opex: оренда, електроенергія, вода, інтернет, зарплати.
- Дані:
  - `Product(id, name, salePrice, unit)`
  - `RecipeItem(id, productId, ingredientId, qtyPerUnit, unit)`
  - `OpexCategory(id, name)`
- Правильна поведінка:
  - Рецепт валідний, якщо всі `qtyPerUnit > 0`.
  - Зміни рецепта не впливають на історичний COGS (тільки майбутні продажі).

## 2. Товари та рецепти
**Призначення**: база для авто-списання інгредієнтів і COGS.
- UI:
  - Список товарів, перегляд рецепта, швидке редагування кількостей.
- Дані:
  - `Ingredient(id, name, avgCost, stockQty, unit)`
- Правильна поведінка:
  - Одиниці виміру узгоджені між рецептом і складом.
  - Оновлення рецепта не перераховує історичні продажі.

## 3. Закупівлі сировини
**Призначення**: поповнення складу і оновлення середньої ціни інгредієнтів.
- UI:
  - Форма: `date`, `ingredientId`, `qty`, `unitPrice`, `supplierId?` (необов’язкове).
  - Історія закупівель: фільтр за датою (фільтр за `supplierId` закладений).
- Дані:
  - `Purchase(id, date, ingredientId, qty, unitPrice, supplierId?)`
- Правильна поведінка:
  - Оновлення складу: `newQty = oldQty + qty`.
  - Оновлення середньої ціни:
    - `newAvgCost = (oldQty*oldAvgCost + qty*unitPrice) / (oldQty + qty)`.
  - Редагування/скасування закупівлі застосовує зворотну операцію на складі та середній ціні.

## 4. Склад / Запаси
**Призначення**: джерело правди для кількостей і середньої ціни.
- UI:
  - Перелік інгредієнтів: `stockQty`, `avgCost`, статус (норм/низький/негативний).
  - Ручне коригування з причиною.
- Дані:
  - `InventoryAdjustment(id, date, ingredientId, deltaQty, reason)`
- Правильна поведінка:
  - Коригування змінює тільки кількість (середня ціна — без змін).
  - Негативні запаси дозволені; показувати бейджі попередження.

## 5. Продажі
**Призначення**: виручка та автоматичний розрахунок COGS.
- UI:
  - Форма: `productId`, `qty`, `salePrice` (за замовчуванням із товару), `date`.
  - Історія: редагування/скасування.
- Дані:
  - `Sale(id, date, productId, qty, salePrice, cogsAmount)`
- Правильна поведінка:
  - Розрахунок COGS (снапшот на момент продажу):
    - `cogsAmount = Σ( qty * recipe.qtyPerUnit * ingredient.avgCost )`.
  - Списання зі складу:
    - `ingredient.stockQty -= qty * recipe.qtyPerUnit`.
  - Редагування/скасування:
    - Перерахунок `cogsAmount` і зворотне коригування складу.

## 6. Операційні витрати (Opex)
**Призначення**: облік постійних/змінних витрат.
- UI:
  - Форма: `categoryId`, `date`, `amount`, `note`. Базові фільтри за датою.
- Дані:
  - `OpexExpense(id, date, categoryId, amount, note)`
- Правильна поведінка:
  - Запис миттєво впливає на чистий прибуток у дашборді.
  - Редагування/видалення оновлює агрегати.

## 7. Дашборд (Прибуток)
**Призначення**: ключові показники у реальному часі.
- UI:
  - Метрики: `Sales`, `COGS`, `Opex`, `GrossProfit`, `NetProfit`, `GrossMargin%`.
  - Періоди: день/тиждень/місяць; швидкі переходи до Продажів/Закупівель/Opex/Звітів.
- Агрегати:
  - `GrossProfit = Sales − COGS`
  - `NetProfit = Sales − COGS − Opex`
  - `GrossMargin% = GrossProfit / Sales`
- Правильна поведінка:
  - Будь-яка операція миттєво оновлює метрики.

## 8. Звітність
**Призначення**: розуміння прибутковості за період.
- UI:
  - Періоди: день/тиждень/місяць. Топ-продукти, структура витрат.
  - Експорт `CSV` (PDF — пізніше).
  - Фільтри: дата (поле `supplierId` закладене для майбутнього).
- Дані:
  - `Report(period, salesTotal, cogsTotal, opexTotal, grossProfit, netProfit, grossMargin)`
- Правильна поведінка:
  - Звіти — read-only; історичний COGS не змінюється при майбутніх змінах рецепта.

## 9. Закриття дня
**Призначення**: фіксація результатів дня.
- UI:
  - Кнопка “Закрити день”: підсумок і підтвердження.
- Дані:
  - `DailyClose(id, date, salesTotal, cogsTotal, opexTotal, netProfit)`
- Правильна поведінка:
  - Генерується денний звіт; редагування не блокуємо (MVP), але логгуємо.

## 10. Сповіщення та бейджі (MVP)
**Призначення**: мінімальні підказки без шуму.
- UI:
  - Бейдж “Низькі запаси” та “Негативні запаси”.
- Правильна поведінка:
  - Поріг низьких запасів — глобальна настройка (наприклад, 2× добове споживання).

## 11. Дані та зберігання
**Моделі**:
- `Product`, `Ingredient`, `RecipeItem`, `Sale`, `Purchase`, `OpexExpense`, `InventoryAdjustment`, `DailyClose`, `Report`.
**Ключові поля**:
- `supplierId` у `Purchase` — необов’язкове; фільтри закладені.
**Ідентифікатори/дати**:
- `id` — UUID, `date` — ISO8601.
**Міграції**:
- Додавання `supplierId` без порушення існуючих даних.

## 12. Домашні сервіси (логіка)
**InventoryService**:
- Закупівля: оновлює `stockQty` і `avgCost`.
- Продаж: списує інгредієнти, застосовує коригування.
- Коригування: змінює тільки `stockQty`.
**CostingService**:
- Рахує `cogsAmount` для продажу на основі рецепта і `avgCost`.
**ReportingService**:
- Агрегує метрики для дашборду/звітів; кешує за періодами.
**OpexService**:
- CRUD витрат, тригер оновлення метрик.

## 13. Валідації та консистентність
- Значення `qty`, `amount` > 0; обов’язкові поля заповнені.
- Негативні запаси дозволені; маркуються бейджами.
- Редагування/скасування операцій робить зворотні дії на складі і перерахунок агрегатів.
- `Sale.cogsAmount` зберігає історичну собівартість; зміни рецепта впливають тільки на майбутнє.

## 14. Тестування (мінімум)
- Продаж 1 порції товару з 2 інгредієнтами: перевірити `cogsAmount` і списання.
- Дві закупівлі одного інгредієнта з різною ціною: перевірити середньозважену `avgCost`.
- Редагування продажу (`qty`): перевірити зворотне списання і новий `cogsAmount`.
- Продаж при `stockQty < needed`: дозволити, позначити “негативні запаси”.
- Opex: додавання/редагування/видалення — коректне оновлення метрик дашборда.

---
Цей документ задає однозначну реалізацію MVP з радикальною простотою: мінімальні форми, автоматичний COGS (середньозважена), миттєві агрегати та готовність до розширення за постачальниками через `supplierId` у `Purchase`.