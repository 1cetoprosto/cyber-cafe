name: Sync repository labels

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      - .github/labels.json

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Sync labels from JSON
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '.github/labels.json';
            const raw = fs.readFileSync(path, 'utf8');
            const labels = JSON.parse(raw);

            async function upsertLabel(label) {
              const name = label.name;
              const color = (label.color || '').replace('#','');
              const description = label.description || '';
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name
                });
                await github.rest.issues.updateLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name,
                  new_name: name,
                  color,
                  description
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name,
                    color,
                    description
                  });
                } else {
                  core.warning(`Failed upserting label ${name}: ${e.message}`);
                }
              }
            }

            for (const l of labels) {
              await upsertLabel(l);
            }
            core.summary.addHeading('Label sync summary').addRaw(`Processed ${labels.length} labels from labels.json`);
